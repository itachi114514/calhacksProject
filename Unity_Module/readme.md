# Unity 模块

该模块同时充当 WebSocket 客户端和服务端角色，作为桥梁将音频数据从上游缓冲处理后，稳定地转发给下游（如虚拟角色渲染模块）。同时支持打断消息和随机切换动作指令。

---

## 🌟 功能说明

- 客户端：连接音频源 `ws://localhost:8767`，接收语音流
- 服务端：监听 `ws://0.0.0.0:8769`，将音频流实时转发至 Unity 等接收端
- 使用异步 buffer 机制保障连续性与稳定性
- 支持打断消息（如 `SAY:false` 清空缓冲区）
- 支持随机切换预设动作（如 `SWITCH_ACTION`）

---

## 🔧 使用方法

1. 启动服务：

   ```bash
   python unity_module.py
   ```

2. 系统将：
   - 自动作为客户端连接 `ws://localhost:8767` 接收音频
   - 同时作为服务端监听 `ws://0.0.0.0:8769`，向 Unity 发送音频

3. Unity 或其他客户端连接 `8769` 即可获取实时音频流。

---

## ⚙️ 配置说明

| 配置项                 | 描述                                                  |
|------------------------|-------------------------------------------------------|
| `LISTENER_URI`         | 上游音频源地址（默认连接 Unity 或 ASR 输出）         |
| `SERVER_PORT`          | 本模块对外的 WebSocket 服务端口（默认 8769）         |
| `CHUNK_SIZE`           | 每次发送的音频块大小，默认 4096 字节（即 0.256 秒音频） |
| `BUFFER_WARN_THRESHOLD`| 缓冲区最大阈值（默认 5MB），避免堆积                   |


---

## 📡 消息格式说明

| 消息类型         | 示例内容                     | 描述                          |
|------------------|------------------------------|-------------------------------|
| 音频流（bytes）   | `b'\x01\x02...'`              | 实际音频流，按块发送            |
| `SAY:false`      | `"SAY:false"`                | 指令，清空缓冲区，重置播放状态 |
| `SWITCH_ACTION`  | `"SWITCH_ACTION"`            | 指令，从预设动作中选一个切换   |
---

## 🔧 启动日志示例

```
启动带缓冲的音频转发器...
  - 作为服务端监听: ws://0.0.0.0:8769
  - 作为客户端连接: ws://localhost:8767?name=Unity_Module
  - 转发块大小: 4096 bytes
[接收端 8767] 成功连接到 ws://localhost:8767
[服务端 8769] 客户端 ('127.0.0.1', 51234) 已连接
[发送端 8769] 发送任务已启动
```

---

## 🧠 注意事项

- 本模块默认只支持 **一个活动连接**（下游客户端），如果已有连接，将自动断开旧连接。
- 为了避免空转，占用过多 CPU，使用 `asyncio.Event` 控制任务调度。

